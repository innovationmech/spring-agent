name: PR æ£€æŸ¥

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  lint:
    name: ä»£ç æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: æˆäºˆ Gradle æ‰§è¡Œæƒé™
        run: chmod +x gradlew

      - name: ä»£ç æ ¼å¼æ£€æŸ¥
        run: ./gradlew checkstyleMain checkstyleTest

  test:
    name: å•å…ƒæµ‹è¯•
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: æˆäºˆ Gradle æ‰§è¡Œæƒé™
        run: chmod +x gradlew

      - name: è¿è¡Œå•å…ƒæµ‹è¯•
        run: ./gradlew test

      - name: ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
        if: always()
        run: ./gradlew jacocoTestReport

      - name: è¯„è®ºæµ‹è¯•è¦†ç›–ç‡
        if: github.event_name == 'pull_request'
        uses: madrapps/jacoco-report@v1.6.1
        with:
          paths: ${{ github.workspace }}/build/reports/jacoco/test/jacocoTestReport.xml
          token: ${{ secrets.GITHUB_TOKEN }}
          min-coverage-overall: 70
          min-coverage-changed-files: 80
          title: 'æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š'

  integration-test:
    name: é›†æˆæµ‹è¯•
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_DB: spring_ai_db
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: æˆäºˆ Gradle æ‰§è¡Œæƒé™
        run: chmod +x gradlew

      - name: è¿è¡Œé›†æˆæµ‹è¯•
        run: ./gradlew integrationTest --tests "*PostgresChatMemoryIntegrationTest" --tests "*VectorStoreIntegrationTest"
        env:
          SPRING_PROFILES_ACTIVE: postgres
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/spring_ai_db
          SPRING_DATASOURCE_USERNAME: postgres
          SPRING_DATASOURCE_PASSWORD: postgres
        continue-on-error: true

  build:
    name: æ„å»ºæ£€æŸ¥
    runs-on: ubuntu-latest
    needs: [lint, test]
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      - name: æˆäºˆ Gradle æ‰§è¡Œæƒé™
        run: chmod +x gradlew

      - name: æ„å»ºé¡¹ç›®
        run: ./gradlew build -x test

  size-check:
    name: PR å¤§å°æ£€æŸ¥
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    
    steps:
      - name: æ£€æŸ¥ PR å¤§å°
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const additions = pr.additions;
            const deletions = pr.deletions;
            const changes = additions + deletions;
            
            let label = '';
            let message = '';
            
            if (changes < 10) {
              label = 'size/XS';
              message = 'âœ… è¿™æ˜¯ä¸€ä¸ªå¾ˆå°çš„ PR';
            } else if (changes < 50) {
              label = 'size/S';
              message = 'âœ… è¿™æ˜¯ä¸€ä¸ªå°å‹ PR';
            } else if (changes < 250) {
              label = 'size/M';
              message = 'âš ï¸ è¿™æ˜¯ä¸€ä¸ªä¸­ç­‰å¤§å°çš„ PR';
            } else if (changes < 500) {
              label = 'size/L';
              message = 'âš ï¸ è¿™æ˜¯ä¸€ä¸ªè¾ƒå¤§çš„ PRï¼Œå»ºè®®æ‹†åˆ†';
            } else {
              label = 'size/XL';
              message = 'âŒ è¿™æ˜¯ä¸€ä¸ªéå¸¸å¤§çš„ PRï¼Œå¼ºçƒˆå»ºè®®æ‹†åˆ†æˆå¤šä¸ªå° PR';
            }
            
            // æ·»åŠ æ ‡ç­¾
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: [label]
            });
            
            // æ·»åŠ è¯„è®º
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: `${message}\n\nğŸ“Š å˜æ›´ç»Ÿè®¡: +${additions} -${deletions} (æ€»è®¡: ${changes})`
            });

  pr-labeler:
    name: PR è‡ªåŠ¨æ ‡ç­¾
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: æ ‡è®° PR
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yml

